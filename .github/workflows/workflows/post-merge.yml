name: PR merged housekeeping

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  delete-merged-branch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      MAIN_BRANCH: ${{ vars.MAIN_BRANCH }}
      DEFAULT_BASE_BRANCH: ${{ vars.DEFAULT_BASE_BRANCH }}
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr = context.payload.pull_request;
            const repo = context.repo;

            const allowedBases = new Set([
              (process.env.MAIN_BRANCH || 'main').trim(),
              (process.env.DEFAULT_BASE_BRANCH || 'development').trim(),
            ].filter(Boolean));

            if (!allowedBases.has(pr.base.ref)) {
              core.info(`Base branch ${pr.base.ref} not in allowed list; skipping.`);
              return;
            }

            // Only delete head branch if it belongs to this repo (not a fork)
            if (pr.head.repo.fork) {
              core.info('PR comes from a fork; skipping branch deletion.');
              return;
            }

            try {
              await github.rest.git.deleteRef({ ...repo, ref: `heads/${pr.head.ref}` });
              core.info(`Deleted branch ${pr.head.ref}`);
            } catch (e) {
              core.warning(`Failed to delete branch ${pr.head.ref}: ${e.message}`);
            }
