name: Enable Auto-merge on label

on:
  pull_request_target:
    types: [labeled]

permissions:
  pull-requests: write
  contents: read

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    env:
      MAIN_BRANCH: ${{ vars.MAIN_BRANCH }}
      DEFAULT_BASE_BRANCH: ${{ vars.DEFAULT_BASE_BRANCH }}
      AUTOMERGE_LABEL: ${{ vars.AUTOMERGE_LABEL }}
      LABEL_FIX: ${{ vars.LABEL_FIX }}
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_PAT || secrets.GL_TOKEN || github.token }}
          script: |
            const pr = context.payload.pull_request;
            const norm = (s) => String(s ?? '').trim();
            const lower = (s) => norm(s).toLowerCase();

            const main = norm(process.env.MAIN_BRANCH) || 'main';
            const dev  = norm(process.env.DEFAULT_BASE_BRANCH) || 'development';
            const automergeLabel = lower(process.env.AUTOMERGE_LABEL || 'automerge');
            const fixLabel = lower(process.env.LABEL_FIX || 'fix');

            const labels = (pr.labels || []).map(l => lower(l.name));
            if (!labels.includes(automergeLabel)) {
              core.info(`PR does not have "${automergeLabel}" label; skipping.`);
              return;
            }

            // Only allow auto-merge into main/dev.
            if (![main, dev].includes(pr.base.ref)) {
              core.info(`Base branch ${pr.base.ref} not allowed; skipping.`);
              return;
            }

            // If targeting main, require FIX classification (label or hotfix/ branch)
            const isHotfixBranch = /^hotfix\//i.test(pr.head.ref);
            const isFix = labels.includes(fixLabel) || lower(pr.title).includes('[fix]') || isHotfixBranch;

            if (pr.base.ref === main && !isFix) {
              core.warning(`Refusing to enable auto-merge into ${main} without "${fixLabel}" label or hotfix/ branch.`);
              return;
            }

            await github.graphql(`
              mutation($id:ID!){
                enablePullRequestAutoMerge(input:{ pullRequestId:$id, mergeMethod:SQUASH }){
                  pullRequest{ number }
                }
              }`, { id: pr.node_id });

            core.info(`Auto-merge enabled for PR #${pr.number}`);
