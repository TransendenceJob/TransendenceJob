name: Issue Triage

on:
  issues:
    types: [opened, reopened, edited]

permissions:
  contents: read
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    env:
      PROJECT_V2_ID: ${{ vars.PROJECT_V2_ID }}
      # Labels
      LABEL_FEATURE: ${{ vars.LABEL_FEATURE }}
      LABEL_BUG: ${{ vars.LABEL_BUG }}
      LABEL_REFACTOR: ${{ vars.LABEL_REFACTOR }}

      # Fields
      PROJECT_FIELD_STATUS_NAME: ${{ vars.PROJECT_FIELD_STATUS_NAME }}
      PROJECT_FIELD_PRIORITY_NAME: ${{ vars.PROJECT_FIELD_PRIORITY_NAME }}
      PROJECT_FIELD_SIZE_NAME: ${{ vars.PROJECT_FIELD_SIZE_NAME }}
      PROJECT_FIELD_IMPORTANCE_NAME: ${{ vars.PROJECT_FIELD_IMPORTANCE_NAME }}

      # Status options
      STATUS_BACKLOG: ${{ vars.STATUS_BACKLOG }}
      STATUS_READY: ${{ vars.STATUS_READY }}

      # Priority options
      PRIORITY_P0: ${{ vars.PRIORITY_P0 }}
      PRIORITY_P1: ${{ vars.PRIORITY_P1 }}
      PRIORITY_P2: ${{ vars.PRIORITY_P2 }}
      PRIORITY_P3: ${{ vars.PRIORITY_P3 }}

      # Size options
      SIZE_FAST: ${{ vars.SIZE_FAST }}
      SIZE_1_3_DAYS: ${{ vars.SIZE_1_3_DAYS }}
      SIZE_UP_TO_5_DAYS: ${{ vars.SIZE_UP_TO_5_DAYS }}
      SIZE_1_WEEK: ${{ vars.SIZE_1_WEEK }}
      SIZE_2_WEEKS_PLUS: ${{ vars.SIZE_2_WEEKS_PLUS }}

      # Importance options
      IMPORTANCE_URGENT: ${{ vars.IMPORTANCE_URGENT }}
      IMPORTANCE_MAIN: ${{ vars.IMPORTANCE_MAIN }}
      IMPORTANCE_SIDETRACK: ${{ vars.IMPORTANCE_SIDETRACK }}
      IMPORTANCE_OVERLOOKED: ${{ vars.IMPORTANCE_OVERLOOKED }}

    steps:
      - name: Auto-triage issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_PAT || github.token }}
          script: |
            const issue = context.payload.issue;
            const repo = context.repo;

            const titleRaw = issue.title || '';
            const bodyRaw = issue.body || '';
            const title = titleRaw.toLowerCase();
            const body = bodyRaw.toLowerCase();

            const issueNumber = issue.number;
            const issueNodeId = issue.node_id;

            const PROJECT_ID = process.env.PROJECT_V2_ID;
            if (!PROJECT_ID) throw new Error('Missing vars.PROJECT_V2_ID');

            // ----------------------
            // 1) Labels from title
            // ----------------------
            const labels = [];
            const lf = (process.env.LABEL_FEATURE || 'feature').trim();
            const lb = (process.env.LABEL_BUG || 'bug').trim();
            const lr = (process.env.LABEL_REFACTOR || 'refactor').trim();

            if (title.includes('[feature]')) labels.push(lf);
            if (title.includes('[bug]')) labels.push(lb);
            if (title.includes('[refactor]')) labels.push(lr);

            if (labels.length) {
              await github.rest.issues.addLabels({ ...repo, issue_number: issueNumber, labels });
            }

            // ---------------------------------
            // 2) Parse Priority/Size/Importance
            // ---------------------------------
            // Priority from {P0..P3} OR [Importance:]
            let priority = null;
            if (body.includes('{p0}')) priority = process.env.PRIORITY_P0 || 'P0';
            else if (body.includes('{p1}')) priority = process.env.PRIORITY_P1 || 'P1';
            else if (body.includes('{p2}')) priority = process.env.PRIORITY_P2 || 'P2';
            else if (body.includes('{p3}')) priority = process.env.PRIORITY_P3 || 'P3';

            // Importance (separate field, if you use it)
            let importance = null;
            if (body.includes('[importance:] urgent')) importance = process.env.IMPORTANCE_URGENT || 'Urgent';
            else if (body.includes('[importance:] main')) importance = process.env.IMPORTANCE_MAIN || 'Main';
            else if (body.includes('[importance:] sidetrack')) importance = process.env.IMPORTANCE_SIDETRACK || 'Sidetrack';
            else if (body.includes('[importance:] overlooked')) importance = process.env.IMPORTANCE_OVERLOOKED || 'Overlooked';

            // Size from [Duration:]
            let size = null;
            if (body.includes('[duration:] 1 day')) size = process.env.SIZE_FAST || 'Fast';
            else if (body.includes('[duration:] 3 days') || body.includes('[duration:] 2 days')) size = process.env.SIZE_1_3_DAYS || '1-3 Days';
            else if (body.includes('[duration:] 5 days') || body.includes('[duration:] 4 days')) size = process.env.SIZE_UP_TO_5_DAYS || 'Up to 5 days';
            else if (body.includes('[duration:] 1 week')) size = process.env.SIZE_1_WEEK || '1 Week';
            else if (body.includes('[duration:] 2 weeks')) size = process.env.SIZE_2_WEEKS_PLUS || '2 Weeks and above';

            // -------------------------
            // 3) Project helpers
            // -------------------------
            async function getProjectFields(projectId) {
              const q = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      id
                      title
                      fields(first: 100) {
                        nodes {
                          __typename
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options { id name }
                          }
                        }
                      }
                    }
                  }
                }`;
              const r = await github.graphql(q, { projectId });
              if (!r.node) throw new Error('Project not found by ID');
              return r.node;
            }

            function findSingleSelectField(project, fieldName) {
              if (!fieldName) return null;
              return project.fields.nodes.find(f => f && f.__typename === 'ProjectV2SingleSelectField' && f.name === fieldName) || null;
            }

            function findOption(field, optionName) {
              if (!field || !optionName) return null;
              return field.options.find(o => o.name === optionName) || null;
            }

            // Find (or create) the project item for this issue
            async function getOrCreateItemId(projectId, contentNodeId) {
              let after = null;
              while (true) {
                const q = `
                  query($projectId: ID!, $after: String) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        items(first: 50, after: $after) {
                          nodes {
                            id
                            content { ... on Issue { id } }
                          }
                          pageInfo { hasNextPage endCursor }
                        }
                      }
                    }
                  }`;
                const r = await github.graphql(q, { projectId, after });
                const page = r.node.items;
                const existing = page.nodes.find(n => n.content?.id === contentNodeId);
                if (existing) return existing.id;
                if (!page.pageInfo.hasNextPage) break;
                after = page.pageInfo.endCursor;
              }

              const added = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                    item { id }
                  }
                }
              `, { projectId, contentId: contentNodeId });

              return added.addProjectV2ItemById.item.id;
            }

            async function setSingleSelect(projectId, itemId, field, option) {
              if (!field || !option) return;
              await github.graphql(`
                mutation($input: UpdateProjectV2ItemFieldValueInput!) {
                  updateProjectV2ItemFieldValue(input: $input) {
                    projectV2Item { id }
                  }
                }
              `, {
                input: {
                  projectId,
                  itemId,
                  fieldId: field.id,
                  value: { singleSelectOptionId: option.id }
                }
              });
            }

            const project = await getProjectFields(PROJECT_ID);
            const itemId = await getOrCreateItemId(PROJECT_ID, issueNodeId);

            // -------------------------
            // 4) Apply field values
            // -------------------------
            const statusFieldName = process.env.PROJECT_FIELD_STATUS_NAME || 'Status';
            const priorityFieldName = process.env.PROJECT_FIELD_PRIORITY_NAME || '';
            const sizeFieldName = process.env.PROJECT_FIELD_SIZE_NAME || '';
            const importanceFieldName = process.env.PROJECT_FIELD_IMPORTANCE_NAME || '';

            const statusField = findSingleSelectField(project, statusFieldName);
            const priorityField = findSingleSelectField(project, priorityFieldName);
            const sizeField = findSingleSelectField(project, sizeFieldName);
            const importanceField = findSingleSelectField(project, importanceFieldName);

            // Status: Backlog if configured, otherwise leave as-is; fallback to Ready if you prefer.
            const backlogName = (process.env.STATUS_BACKLOG || '').trim();
            const readyName = (process.env.STATUS_READY || '').trim();
            const statusTarget = backlogName || readyName || '';
            if (statusField && statusTarget) {
              const opt = findOption(statusField, statusTarget);
              if (!opt) core.warning(`Status option "${statusTarget}" not found; skipping status update.`);
              else await setSingleSelect(PROJECT_ID, itemId, statusField, opt);
            }

            if (priorityField && priority) {
              const opt = findOption(priorityField, priority);
              if (!opt) core.warning(`Priority option "${priority}" not found; skipping priority.`);
              else await setSingleSelect(PROJECT_ID, itemId, priorityField, opt);
            }

            if (sizeField && size) {
              const opt = findOption(sizeField, size);
              if (!opt) core.warning(`Size option "${size}" not found; skipping size.`);
              else await setSingleSelect(PROJECT_ID, itemId, sizeField, opt);
            }

            if (importanceField && importance) {
              const opt = findOption(importanceField, importance);
              if (!opt) core.warning(`Importance option "${importance}" not found; skipping importance.`);
              else await setSingleSelect(PROJECT_ID, itemId, importanceField, opt);
            }

            core.info(`Triaged issue #${issueNumber}. Labels: ${labels.join(', ') || 'none'}. Fields: status=${statusTarget || 'unchanged'} priority=${priority || 'none'} size=${size || 'none'} importance=${importance || 'none'}`);
