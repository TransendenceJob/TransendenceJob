name: Add PRs to Project

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  add-pr-to-project:
    runs-on: ubuntu-latest
    env:
      PROJECT_V2_ID: ${{ vars.PROJECT_V2_ID }}
      PROJECT_FIELD_STATUS_NAME: ${{ vars.PROJECT_FIELD_STATUS_NAME }}
      STATUS_PULL_REQUESTS: ${{ vars.STATUS_PULL_REQUESTS }}
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_PAT }}
          script: |
            const pr = context.payload.pull_request;
            const repo = context.repo;

            const norm = (s) => String(s ?? '').trim();
            const projectId = norm(process.env.PROJECT_V2_ID);
            const statusFieldName = norm(process.env.PROJECT_FIELD_STATUS_NAME || 'Status');
            const targetOptionName = norm(process.env.STATUS_PULL_REQUESTS || 'Pull Requests');

            if (!projectId) {
              core.warning('PROJECT_V2_ID not set; skipping.');
              return;
            }

            // Fetch Project fields and find Status field + target option
            const projQ = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    id
                    title
                    fields(first: 100) {
                      nodes {
                        __typename
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }
            `;
            const proj = await github.graphql(projQ, { projectId });
            const project = proj.node;

            const statusField = project.fields.nodes.find(f =>
              f.__typename === 'ProjectV2SingleSelectField' && f.name === statusFieldName
            );
            if (!statusField) {
              core.warning(`Status field "${statusFieldName}" not found.`);
              return;
            }

            const targetOpt = (statusField.options || []).find(o => o.name === targetOptionName);
            if (!targetOpt) {
              core.warning(`Status option "${targetOptionName}" not found.`);
              core.info(`Available options: ${(statusField.options||[]).map(o=>o.name).join(' | ')}`);
              return;
            }

            // Add PR to project (contentId = PR node_id)
            const addM = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
            `;
            const add = await github.graphql(addM, { projectId, contentId: pr.node_id });
            const itemId = add.addProjectV2ItemById.item.id;

            // Set status to Pull Requests
            const setM = `
              mutation($input: UpdateProjectV2ItemFieldValueInput!) {
                updateProjectV2ItemFieldValue(input: $input) { projectV2Item { id } }
              }
            `;
            await github.graphql(setM, {
              input: {
                projectId,
                itemId,
                fieldId: statusField.id,
                value: { singleSelectOptionId: targetOpt.id }
              }
            });

            core.info(`Added PR #${pr.number} to Project "${project.title}" and set status "${targetOptionName}".`);
